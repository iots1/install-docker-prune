#!/bin/bash

# ==============================================================================
#  à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¹à¸¥à¸°à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸š Docker Prune à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹à¸šà¸š Aggressive
# ==============================================================================
#
#  à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸™à¸µà¹‰à¸ˆà¸°à¸—à¸³à¸à¸²à¸£:
#  1. à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œ docker_aggressive_prune.sh à¹ƒà¸™ /usr/local/bin/
#  2. à¸ªà¸£à¹‰à¸²à¸‡ Cron job à¹ƒà¸™ /etc/cron.d/ à¹€à¸žà¸·à¹ˆà¸­à¸£à¸±à¸™à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸—à¸¸à¸à¸§à¸±à¸™à¸•à¸­à¸™ 08:30 à¸™.
#  3. à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² logrotate à¹ƒà¸™ /etc/logrotate.d/ à¹€à¸žà¸·à¹ˆà¸­à¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¸™à¸²à¸”à¹„à¸Ÿà¸¥à¹Œ Log
#
#  à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰:
#  1. à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸™à¸µà¹‰à¹€à¸›à¹‡à¸™à¹„à¸Ÿà¸¥à¹Œ à¹€à¸Šà¹ˆà¸™ install_docker_prune.sh
#  2. à¸£à¸±à¸™à¸”à¹‰à¸§à¸¢à¸„à¸³à¸ªà¸±à¹ˆà¸‡: sudo bash install_docker_prune.sh
#
# ==============================================================================

# à¸«à¸¢à¸¸à¸”à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸—à¸±à¸™à¸—à¸µà¸«à¸²à¸à¸¡à¸µà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹ƒà¸”à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§
set -e

# --- à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸£à¸±à¸™à¸”à¹‰à¸§à¸¢à¸ªà¸´à¸—à¸˜à¸´à¹Œ root à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ ---
if [ "$(id -u)" -ne 0 ]; then
  echo "âŒ à¸à¸£à¸¸à¸“à¸²à¸£à¸±à¸™à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸™à¸µà¹‰à¸”à¹‰à¸§à¸¢à¸ªà¸´à¸—à¸˜à¸´à¹Œ root à¸«à¸£à¸·à¸­à¹ƒà¸Šà¹‰ sudo" >&2
  exit 1
fi

echo "ðŸš€ à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸à¸²à¸£à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¸£à¸°à¸šà¸š Docker Prune à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´..."
echo "----------------------------------------------------"

# --- à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸—à¸µà¹ˆ 1: à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œ Prune ---
echo ">>> 1. à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œ prune à¹ƒà¸™ /usr/local/bin/docker_aggressive_prune.sh..."

cat > /usr/local/bin/docker_aggressive_prune.sh << 'EOF'
#!/bin/bash
echo "========== Starting AGGRESSIVE Docker system prune at $(date) =========="
/usr/bin/docker system prune -a -f
echo "========== AGGRESSIVE Docker system prune finished at $(date) =========="
echo ""
EOF

chmod +x /usr/local/bin/docker_aggressive_prune.sh
echo "âœ… à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œ Prune à¸ªà¸³à¹€à¸£à¹‡à¸ˆ"
echo ""

# --- à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸—à¸µà¹ˆ 2: à¸ªà¸£à¹‰à¸²à¸‡ Cron Job ---
# à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸™ /etc/cron.d/ à¹€à¸›à¹‡à¸™à¸§à¸´à¸˜à¸µà¸—à¸µà¹ˆà¹à¸™à¸°à¸™à¸³à¸ªà¸³à¸«à¸£à¸±à¸š system-wide cron jobs
echo ">>> 2. à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡ Cron job à¹ƒà¸™ /etc/cron.d/docker-prune..."

cat > /etc/cron.d/docker-prune << 'EOF'
# à¸£à¸±à¸™à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸¥à¹‰à¸²à¸‡ Docker à¹à¸šà¸š aggressive à¸—à¸¸à¸à¸§à¸±à¸™ à¹€à¸§à¸¥à¸² 08:30 à¸™.
30 8 * * * root /usr/local/bin/docker_aggressive_prune.sh >> /var/log/docker-prune.log 2>&1
EOF

# à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² permission à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸ªà¸³à¸«à¸£à¸±à¸š cron file
chmod 0644 /etc/cron.d/docker-prune

echo "âœ… à¸ªà¸£à¹‰à¸²à¸‡ Cron job à¸ªà¸³à¹€à¸£à¹‡à¸ˆ"
echo ""

# --- à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸—à¸µà¹ˆ 3: à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Logrotate ---
echo ">>> 3. à¸à¸³à¸¥à¸±à¸‡à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Logrotate à¹ƒà¸™ /etc/logrotate.d/docker-prune..."

cat > /etc/logrotate.d/docker-prune << 'EOF'
/var/log/docker-prune.log {
    size 5M
    rotate 4
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
}
EOF

echo "âœ… à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Logrotate à¸ªà¸³à¹€à¸£à¹‡à¸ˆ"
echo ""

# --- à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™ ---
echo "----------------------------------------------------"
echo "ðŸŽ‰ à¸à¸²à¸£à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ!"
echo "à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸ˆà¸°à¸—à¸³à¸à¸²à¸£à¸¥à¹‰à¸²à¸‡ Docker à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸—à¸¸à¸à¸§à¸±à¸™à¸•à¸­à¸™ 08:30 à¸™."
